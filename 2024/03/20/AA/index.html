<!-- build time:Wed Jun 12 2024 14:09:18 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="人生当苦, 良人当归" href="https://fairyeye.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="人生当苦, 良人当归" href="https://fairyeye.github.io/atom.xml"><link rel="alternate" type="application/json" title="人生当苦, 良人当归" href="https://fairyeye.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="学习"><link rel="canonical" href="https://fairyeye.github.io/2024/03/20/AA/"><title>拉勾训练营5期 | Li = 人生当苦, 良人当归</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">拉勾训练营5期</h1><div class="meta"><span class="item" title="创建时间：2024-03-20 16:15:40"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-03-20T16:15:40+08:00">2024-03-20</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>7.7k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>7 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Li</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipex2cdtbj20zk0m8x6p.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclga70tsj20zk0m84mr.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giph4wqtg4j20zk0m8x6p.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipetlbztpj20zk0m84qp.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclj61ylzj20zk0m8b29.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipev1x5e4j20zk0m8b29.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://fairyeye.github.io/2024/03/20/AA/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="有李说不清"><meta itemprop="description" content=", 我不过像你像他像那野草野花。"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="人生当苦, 良人当归"></span><div class="body md" itemprop="articleBody"><h1 id="jdbc"><a class="anchor" href="#jdbc">#</a> JDBC</h1><p>需要手动引入 Mysql 的 jar 包</p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBCDemo</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException &#123;  </span><br><span class="line">        <span class="comment">// 加载驱动  </span></span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);  </span><br><span class="line">        <span class="comment">// 建立连接  </span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(<span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;12345678&quot;</span>);  </span><br><span class="line">        <span class="comment">// 定义SQL语句  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from db_account where id = 4&quot;</span>;  </span><br><span class="line">        <span class="comment">// 获取预处理prepareStatement  </span></span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> connection.prepareStatement(sql);  </span><br><span class="line">        <span class="comment">// 设置参数  </span></span><br><span class="line">        <span class="comment">// preparedStatement.setInt(1, 4);  </span></span><br><span class="line">        <span class="comment">// 执行查询 得到结果  </span></span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> preparedStatement.executeQuery(sql);  </span><br><span class="line">        <span class="comment">// 处理结果  </span></span><br><span class="line">        <span class="keyword">while</span> (resultSet.next()) &#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;id:&quot;</span> + resultSet.getInt(<span class="string">&quot;id&quot;</span>));  </span><br><span class="line">            System.out.println(<span class="string">&quot;email:&quot;</span> + resultSet.getString(<span class="string">&quot;email&quot;</span>));  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><ol><li>为什么要有 ORM 框架</li></ol><ul><li>驱动 uri、数据库地址、账号密码，硬编码，不灵活</li><li>重复的建立连接</li><li>处理结果集麻烦</li></ul><h2 id="自定义"><a class="anchor" href="#自定义">#</a> 自定义</h2><h3 id="创建两个工程"><a class="anchor" href="#创建两个工程">#</a> 创建两个工程</h3><ul><li>IPersistence、IPersistence_Test</li></ul><h4 id="ipersistence_test-使用端"><a class="anchor" href="#ipersistence_test-使用端">#</a> IPersistence_Test 使用端</h4><h4 id="ipersistence-自定义框架"><a class="anchor" href="#ipersistence-自定义框架">#</a> IPersistence 自定义框架</h4><h5 id="根据配置文件的路径将配置文件加载成字节输入流存储在内存中"><a class="anchor" href="#根据配置文件的路径将配置文件加载成字节输入流存储在内存中">#</a> 根据配置文件的路径，将配置文件加载成字节输入流，存储在内存中</h5><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Resources.getResourceAsStream(String path)</span><br></pre></td></tr></table></figure><p></p><ol><li>获得 sqlSession 对象</li></ol><p>sqlSession 通过 sqlSessionFatory.open 获得<br>sqlSessionFatory 通过 sqlSessionFatoryBuilder.build (configuration) 获得<br>build 需要获取数据库信息</p><ul><li>创建 SqlSessionFactoryBuilder</li><li>通过 SqlSessionFatoryBuilder.build () 获得 SqlSessionFatory</li><li>通过 DefaultSqlSessionFactory.open () 获得 SqlSession</li><li>创建 DefaultSqlSession 实现基础方法 selectAll，selectList</li></ul><ol start="2"><li>执行 JDBC 逻辑</li></ol><p>创建 Executor、Executor 实现类，执行 CURD</p><ol start="3"><li>处理返回结果</li></ol><p>通过反射或内省 + SQLID 上的 resultType 全路径，处理返参</p><ul><li>问题 1：数据库类型与实体类型不一致<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.IllegalArgumentException: argument type mismatch at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) at java.lang.reflect.Method.invoke(Method.java:498)</span><br></pre></td></tr></table></figure></li><li>问题 2：数据库版本与驱动版本不一致</li></ul><p>无法获取数据库连接，报错信息和获取连接方法有关</p><p>使用 C3P0 连接池是报错：<br></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.sql.SQLException: Connections could not be acquired from the underlying database!</span><br></pre></td></tr></table></figure><p></p><p>使用 DriverManager 直接连接时：<br></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client does not support authentication protocol requested by server; consider upgrading MySQL client</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><ol start="4"><li>持久层实现</li></ol><p>通过 mapper 接口，数据库的交互</p><p>SqlSession 中创建一个 getMapper 方法，获取 mapper 的代理类，执行被代理类的方法</p><h1 id="mybatis"><a class="anchor" href="#mybatis">#</a> Mybatis</h1><h3 id="概念"><a class="anchor" href="#概念">#</a> 概念</h3><p>基于 ORM 的 <code>半自动</code> 轻量级持久层框架。</p><h3 id="缓存"><a class="anchor" href="#缓存">#</a> 缓存</h3><p><strong>底层数据结构：</strong> 就是一个 HashMap。</p><p><code>先去缓存中查，然后到数据库中，如果缓存中有，就直接返回，不再去数据库查询。</code></p><h4 id="一级缓存-sqlsession级别"><a class="anchor" href="#一级缓存-sqlsession级别">#</a> <strong>一级缓存 - SqlSession 级别</strong></h4><p><strong>是否启用：</strong> 默认开启</p><p><code>cacheKey: org.apache.ibatis.executor.BaseExecutor#createCacheKey</code></p><p>增删改操作时，会刷新缓存（<strong>全部缓存</strong>）</p><h4 id="二级缓存-namespace级别"><a class="anchor" href="#二级缓存-namespace级别">#</a> <strong>二级缓存 - NameSpace 级别</strong></h4><p><strong>是否启用：</strong> 默认关闭，需要手动开启</p><ul><li><p>[I] 二级缓存是在 SqlSession 事务提交时写入的</p></li><li><p>[!] 二级缓存在分布式的情况下，可能有问题。</p></li></ul><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">secondLevelCacheTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;sqlMapConfig.xml&quot;</span>);  </span><br><span class="line">    <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">sqlSession1</span> <span class="operator">=</span> sqlSessionFactory.openSession();  </span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">sqlSession2</span> <span class="operator">=</span> sqlSessionFactory.openSession();  </span><br><span class="line">  </span><br><span class="line">    <span class="type">IUserMapper</span> <span class="variable">mapper1</span> <span class="operator">=</span> sqlSession1.getMapper(IUserMapper.class);  </span><br><span class="line">    <span class="type">IUserMapper</span> <span class="variable">mapper2</span> <span class="operator">=</span> sqlSession2.getMapper(IUserMapper.class);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> mapper1.selectByPrimaryKey(<span class="number">1</span>);  </span><br><span class="line">    <span class="comment">// 这样是不会查到二级缓存的，需要事务提交或者关闭后才可以</span></span><br><span class="line">    <span class="comment">// sqlSession1.commit();  </span></span><br><span class="line">    <span class="comment">// sqlSession1.close();  </span></span><br><span class="line">  </span><br><span class="line">    <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> mapper2.selectByPrimaryKey(<span class="number">1</span>);  </span><br><span class="line">  </span><br><span class="line">    System.out.println(user1==user2);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><strong>结论：</strong> 节省了数据库的交互</p><p><strong>Q:</strong><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">firstLevelCacheTest3</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(<span class="string">&quot;sqlMapConfig.xml&quot;</span>);  </span><br><span class="line">    <span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession(<span class="literal">true</span>);  </span><br><span class="line">    <span class="type">SqlSession</span> <span class="variable">sqlSession2</span> <span class="operator">=</span> sqlSessionFactory.openSession(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">IUserMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> sqlSession.getMapper(IUserMapper.class);  </span><br><span class="line">    <span class="type">IUserMapper</span> <span class="variable">mapper2</span> <span class="operator">=</span> sqlSession2.getMapper(IUserMapper.class);  </span><br><span class="line">  </span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> mapper.selectByPrimaryKey(<span class="number">1</span>);  </span><br><span class="line">    System.out.println(user);  </span><br><span class="line">    mapper2.updateUserByPrimaryKey(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1</span>, <span class="string">&quot;gaga&quot;</span>));  </span><br><span class="line">    <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> mapper.selectByPrimaryKey(<span class="number">1</span>);  </span><br><span class="line">    System.out.println(user1); </span><br><span class="line">    System.out.println(<span class="string">&quot;user == user1: &quot;</span> + (user == user1)); </span><br><span class="line">    sqlSession.close();  </span><br><span class="line">    sqlSession2.close();  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// User&#123;id=1, name=&#x27;haha&#x27;&#125;</span></span><br><span class="line"><span class="comment">// User&#123;id=1, name=&#x27;haha&#x27;&#125;</span></span><br><span class="line"><span class="comment">// user == user1: true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><h3 id="插件"><a class="anchor" href="#插件">#</a> 插件</h3><ul><li>[I] 需要在 SqlMapConfig.xml 中启用</li></ul><p></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">&quot;com.li.plugin.MyPlugin&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><h4 id="分页插件"><a class="anchor" href="#分页插件">#</a> 分页插件</h4><p><strong>拦截器实现</strong></p><ul><li><p>[*] <code>com.github.pagehelper.PageHelper</code></p></li><li><p>[*] 入口： <code>com.github.pagehelper.SqlUtil#_processPage</code></p></li><li><p>[*] 增加 COUNTSQL： <code>com.github.pagehelper.MSUtils#processCountMappedStatement(MappedStatement ms, SqlSource sqlSource, Object[] args)</code></p></li><li><p>countSql 返回结果大于 0 时，执行分页，将总数设置到 page 对象中</p></li><li><p>替换参数 <code>com.github.pagehelper.MSUtils#processPageMappedStatement(MappedStatement ms, SqlSource sqlSource, Page page, Object[] args)</code></p></li><li><p>创建新的 mapperStatement，执行分页 SQL</p></li><li><p>设置分页参数： <code>com.github.pagehelper.MSUtils#setPageParameter</code></p></li></ul><h4 id="通用mapper"><a class="anchor" href="#通用mapper">#</a> 通用 Mapper</h4><h3 id="架构原理"><a class="anchor" href="#架构原理">#</a> 架构原理</h3><h4 id="架构设计"><a class="anchor" href="#架构设计">#</a> 架构设计</h4><h5 id="接口"><a class="anchor" href="#接口">#</a> 接口</h5><ul><li>通过 sqlSession.method (statementId) 或者 Mapper 代理类调用方法，执行主句的增删改查。</li><li>调用接口修改配置信息等。</li></ul><h5 id="数据处理"><a class="anchor" href="#数据处理">#</a> 数据处理</h5><ul><li>请求参数处理 (@Param)：ParameterHandler</li><li>SQL 解析 (处理占位符、Mapper 标签)：SqlSource</li><li>SQL 执行 (JDBC)：Executor</li><li>返回结果处理 (类型转换等)：ResultSetHandler</li></ul><h5 id="框架支撑"><a class="anchor" href="#框架支撑">#</a> 框架支撑</h5><ul><li>事务管理</li><li>连接池管理</li><li>缓存机制</li></ul><h4 id="主要构件"><a class="anchor" href="#主要构件">#</a> 主要构件</h4><ul><li><p>SqlSession：session 表示与数据库的连接</p></li><li><p>Executor：执行器</p></li><li><p>StatementHandler：</p></li><li><p>ParameterHandler：</p></li><li><p>BoundSql：</p></li><li><p>ResultSetHander：</p></li><li><p>TypeHandler：数据库类型与 JavaBean 类型的转换</p></li><li><p>MappedStatement：</p></li><li><p>SqlSource：</p></li></ul><h4 id="总体流程"><a class="anchor" href="#总体流程">#</a> 总体流程</h4><ol><li>SqlSessionFactoryBuilder 获取 SqlSessionFactory</li><li>SqlSessionFactory.openSession 获取 SqlSession 对象</li><li>通过 getMapper 获取 Mapper 代理对象</li><li>执行代理 Mapper 的方法</li><li>=&gt; Executor Mybatis 的执行器</li><li>=&gt; StatementHandler 与 JDBC Statement 的交互</li><li>=&gt; ParameterHandler 处理方法中携带的参数，拼接到 Sql 中</li><li>=&gt; 执行 JDBC 流程（加载驱动、建立连接、定义 Sql、获取预处理对象、处理参数、执行、处理返回结果）</li><li>=&gt; 处理 Java 类型和数据库类型映射</li></ol><h3 id="源码分析"><a class="anchor" href="#源码分析">#</a> 源码分析</h3><h4 id="getmapper"><a class="anchor" href="#getmapper">#</a> getMapper</h4><p>扫描 @Mapper 注解、从 sqlMapConfigXml 中读取 Mapper 包名，或者 Mapper 接口，将其存到 MapperRegistry.knownMappers 中<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure><p></p><p>value 值存储的是一个工厂类，有个 <code>Class&lt;T&gt;</code> 的变量，和 <code>newInstance(SqlSession sqlSession)</code> 方法，用于给 Mapper 创建代理对象</p><ul><li>[*] <code>Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[]&#123;mapperInterface&#125;, mapperProxy);</code></li></ul><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JDK动态代理 生成代理对象</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * loader 类加载器</span></span><br><span class="line"><span class="comment"> * interfaces 代理对象类型</span></span><br><span class="line"><span class="comment"> * h InvocationHandler接口的实现类，需要实现invoke方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">newProxyInstance(ClassLoader loader,  </span><br><span class="line">                                      Class&lt;?&gt;[] interfaces,  </span><br><span class="line">                                      InvocationHandler h)</span><br></pre></td></tr></table></figure><p></p><h4 id="二级缓存"><a class="anchor" href="#二级缓存">#</a> 二级缓存</h4><ul><li><p>[*] <code>org.apache.ibatis.executor.CachingExecutor#flushCacheIfRequired</code></p></li><li><p>[*] <code>org.apache.ibatis.builder.MapperBuilderAssistant#addMappedStatement(java.lang.String, org.apache.ibatis.mapping.SqlSource, org.apache.ibatis.mapping.StatementType, org.apache.ibatis.mapping.SqlCommandType, java.lang.Integer, java.lang.Integer, java.lang.String, java.lang.Class&lt;?&gt;, java.lang.String, java.lang.Class&lt;?&gt;, org.apache.ibatis.mapping.ResultSetType, boolean, boolean, boolean, org.apache.ibatis.executor.keygen.KeyGenerator, java.lang.String, java.lang.String, java.lang.String, org.apache.ibatis.scripting.LanguageDriver, java.lang.String)</code></p></li><li><p>[?] 二级缓存需要再事务提交后或者关闭后生效</p></li></ul><p><code>org.apache.ibatis.executor.CachingExecutor#query(org.apache.ibatis.mapping.MappedStatement, java.lang.Object, org.apache.ibatis.session.RowBounds, org.apache.ibatis.session.ResultHandler, org.apache.ibatis.cache.CacheKey, org.apache.ibatis.mapping.BoundSql)</code></p><p>=&gt; 使用 <code>CachingExecutor.query()</code><br>=&gt; 清空缓存<br>=&gt;<br></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// 从二级缓存中，获取结果</span><br><span class="line">List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);</span><br><span class="line">getObject =&gt; TransactionalCacheManager.transactionalCaches.delegate中获取缓存</span><br><span class="line"></span><br><span class="line">// 如果没有取到 去一级缓存中取</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 缓存查询结果  </span><br><span class="line">tcm.putObject(cache, key, list);</span><br><span class="line"></span><br><span class="line">=&gt; 实际是存到了entriesToAddOnCommit中</span><br><span class="line"></span><br><span class="line">transactionalCaches中有一个：</span><br><span class="line">private final Map&lt;Object, Object&gt; entriesToAddOnCommit;</span><br><span class="line"></span><br><span class="line">public void putObject(Cache cache, CacheKey key, Object value) &#123;  </span><br><span class="line">    // 存入TransactionalCache的缓存中  </span><br><span class="line">    getTransactionalCache(cache).putObject(key, value);  </span><br><span class="line">&#125;</span><br><span class="line">=&gt; </span><br><span class="line">entriesToAddOnCommit.put(key, object);</span><br><span class="line"></span><br><span class="line">transactionalCaches中有一个flushPendingEntries方法，该方法会在事务提交、关闭时会调用，这也是二级缓存需要在事务提交或者关闭后才能查到的原因</span><br><span class="line">// 将 entriesToAddOnCommit、entriesMissedInCache 刷入 delegate(cache) 中  </span><br><span class="line">flushPendingEntries();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><ul><li>[?] 二级缓存为什么使用的是 <code>CachingExecutor</code></li></ul><p>sqlSessionFactory.openSession () 时会 new Executor<br><code>org.apache.ibatis.session.defaults.DefaultSqlSessionFactory#openSessionFromDataSource</code></p><p><code>org.apache.ibatis.session.Configuration#newExecutor(org.apache.ibatis.transaction.Transaction, org.apache.ibatis.session.ExecutorType)</code></p><div class="tags"><a href="/tags/%E5%AD%A6%E4%B9%A0/" rel="tag"><i class="ic i-tag"></i> 学习</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-04-10 17:14:21" itemprop="dateModified" datetime="2024-04-10T17:14:21+08:00">2024-04-10</time> </span><span id="2024/03/20/AA/" class="item leancloud_visitors" data-flag-title="拉勾训练营5期" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="有李说不清 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="有李说不清 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="有李说不清 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>有李说不清 <i class="ic i-at"><em>@</em></i>人生当苦, 良人当归</li><li class="link"><strong>本文链接：</strong> <a href="https://fairyeye.github.io/2024/03/20/AA/" title="拉勾训练营5期">https://fairyeye.github.io/2024/03/20/AA/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/03/13/Spring%20Boot%20Admin/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclffsa1cj20zk0m811l.jpg" title="Spring Boot Admin"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> java</span><h3>Spring Boot Admin</h3></a></div><div class="item right"><a href="/2024/06/08/%E8%8B%8F%E5%B7%9E%E4%B8%80%E6%97%A5%E6%B8%B8%201/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicm0n457cj20zk0m8e81.jpg" title="苏州一日游"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>苏州一日游</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#jdbc"><span class="toc-number">1.</span> <span class="toc-text">JDBC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.</span> <span class="toc-text">自定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%A4%E4%B8%AA%E5%B7%A5%E7%A8%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">创建两个工程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ipersistence_test-%E4%BD%BF%E7%94%A8%E7%AB%AF"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">IPersistence_Test 使用端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ipersistence-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A1%86%E6%9E%B6"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">IPersistence 自定义框架</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E8%B7%AF%E5%BE%84%E5%B0%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%88%90%E5%AD%97%E8%8A%82%E8%BE%93%E5%85%A5%E6%B5%81%E5%AD%98%E5%82%A8%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD"><span class="toc-number">1.1.1.2.1.</span> <span class="toc-text">根据配置文件的路径，将配置文件加载成字节输入流，存储在内存中</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mybatis"><span class="toc-number">2.</span> <span class="toc-text">Mybatis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">2.0.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-number">2.0.2.</span> <span class="toc-text">缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98-sqlsession%E7%BA%A7%E5%88%AB"><span class="toc-number">2.0.2.1.</span> <span class="toc-text">一级缓存 - SqlSession 级别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98-namespace%E7%BA%A7%E5%88%AB"><span class="toc-number">2.0.2.2.</span> <span class="toc-text">二级缓存 - NameSpace 级别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6"><span class="toc-number">2.0.3.</span> <span class="toc-text">插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6"><span class="toc-number">2.0.3.1.</span> <span class="toc-text">分页插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%94%A8mapper"><span class="toc-number">2.0.3.2.</span> <span class="toc-text">通用 Mapper</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86"><span class="toc-number">2.0.4.</span> <span class="toc-text">架构原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.0.4.1.</span> <span class="toc-text">架构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.0.4.1.1.</span> <span class="toc-text">接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-number">2.0.4.1.2.</span> <span class="toc-text">数据处理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E6%94%AF%E6%92%91"><span class="toc-number">2.0.4.1.3.</span> <span class="toc-text">框架支撑</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E6%9E%84%E4%BB%B6"><span class="toc-number">2.0.4.2.</span> <span class="toc-text">主要构件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="toc-number">2.0.4.3.</span> <span class="toc-text">总体流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.0.5.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#getmapper"><span class="toc-number">2.0.5.1.</span> <span class="toc-text">getMapper</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="toc-number">2.0.5.2.</span> <span class="toc-text">二级缓存</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="有李说不清" data-src="/images/avatar.jpg"><p class="name" itemprop="name">有李说不清</p><div class="description" itemprop="description">我不过像你像他像那野草野花。</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">43</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">9</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">20</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhaXJ5ZXll" title="https:&#x2F;&#x2F;github.com&#x2F;fairyeye"><i class="ic i-github"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2024/03/13/Spring%20Boot%20Admin/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/06/08/%E8%8B%8F%E5%B7%9E%E4%B8%80%E6%97%A5%E6%B8%B8%201/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/2023/12/25/Algo/" title="Hello Algo">Hello Algo</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" title="分类于 数据库">数据库</a></div><span><a href="/2023/06/05/%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98/" title="Transactional注解">Transactional注解</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" title="分类于 中间件">中间件</a></div><span><a href="/2023/06/05/Nacos/" title="Nacos">Nacos</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2020/04/15/15/" title="Hexo">Hexo</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/01/19/Leetcode/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2023/06/05/FileUtils/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="分类于 学习笔记">学习笔记</a></div><span><a href="/2020/04/20/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%AC%94%E8%AE%B0/" title="设计模式笔记">设计模式笔记</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/03/20/AA/" title="拉勾训练营5期">拉勾训练营5期</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java/" title="分类于 java">java</a></div><span><a href="/2023/06/05/StringToInteger/" title="StringToInteger">StringToInteger</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="分类于 学习笔记">学习笔记</a></div><span><a href="/2023/06/05/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" title="单例模式">单例模式</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">有李说不清 @ Li</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">83k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">1:15</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/03/20/AA/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->